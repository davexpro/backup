# MySQL & GitLab Backup Tool

A high-performance backup tool written in Go, supporting multi-threaded MySQL dumps via `mysqlsh` and automated GitLab backups from Docker containers.

## Features

- **MySQL Backups**: Uses `mysqlsh` for multi-threaded, faster logical dumps.
- **GitLab Backups**: Automates `gitlab-rake` inside Docker containers and fetches critical config/secrets.
- **Object Storage**: Uploads backups to S3-compatible storage (Cloudflare R2, MinIO, etc.).
- **Encryption**: All backups are password-protected using Zip encryption.
- **Local Mode**: Support for `--only-dump` to keep backups locally.
- **History Logging**: Logs all backup operations to a MySQL database (`sys_backup.backup_logs`).
- **Notifications**: Sends backup reports via Telegram.

## Commands

### `mysql`
Runs the MySQL backup workflow for all databases (excluding system/configured ones).
```bash
./backup mysql [--config config.yaml] [--only-dump]
```

### `gitlab`
Runs the GitLab backup workflow for the container specified in `config.yaml`.
```bash
./backup gitlab [--config config.yaml] [--only-dump]
```

### `setup`
Installs system dependencies (`mysql-shell`) on Debian-based systems.
```bash
./backup setup
```

## GitLab Backup Details

The `gitlab` command performs a comprehensive backup of a GitLab instance running in Docker. It captures the following:

1.  **GitLab Data**: A full backup tarball generated by `gitlab-rake gitlab:backup:create`. This includes the database, repositories, and uploads.
2.  **Configuration**: `/etc/gitlab/gitlab.rb` - The main GitLab configuration file containing your instance settings.
3.  **Secrets**: `/etc/gitlab/gitlab-secrets.json` - Critical secrets required to decrypt database data and user-provided certificates.

> [!IMPORTANT]
> To restore a GitLab instance, you **must** have both the data tarball and the `gitlab-secrets.json` file.

## Configuration

Refer to `config.yaml.example` for the required configuration structure. Ensure your MySQL and Object Storage credentials are correct.

```yaml
mysql:
  host: "127.0.0.1"
  port: 3306
  user: "root"
  password: "password"

gitlab:
  container_name: "gitlab-ce"

r2:
  endpoint: "https://<account_id>.r2.cloudflarestorage.com"
  access_key: "<access_key>"
  secret_key: "<secret_key>"
  bucket: "my-backups"

encryption:
  password: "secure-zip-password"
```

## Installation

```bash
go build -o backup ./cmd/backup
sudo ./backup setup  # On Debian/Ubuntu to install mysqlsh
```
